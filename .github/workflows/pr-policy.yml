name: PR Policy

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  validate:
    name: Validate PR workflow policy
    runs-on: ubuntu-latest
    steps:
      - name: Check branch, title, and closing issue
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const failures = [];

            const branchPattern = /^codex\/issue-(\d+)-[a-z0-9]+(?:-[a-z0-9]+)*$/;
            const titlePattern = /^fix\(issue-(\d+)\):\s.+$/;
            const closesPattern = /closes\s+#(\d+)/i;

            if (pr.base.ref !== "main") {
              failures.push(`PR base branch must be "main", got "${pr.base.ref}".`);
            }

            const branchMatch = pr.head.ref.match(branchPattern);
            if (!branchMatch) {
              failures.push(
                `Branch name must match "codex/issue-<id>-<slug>", got "${pr.head.ref}".`
              );
            }

            const titleMatch = (pr.title || "").match(titlePattern);
            if (!titleMatch) {
              failures.push(
                `PR title must match "fix(issue-<id>): <summary>", got "${pr.title}".`
              );
            }

            const body = pr.body || "";
            const closesMatch = body.match(closesPattern);
            if (!closesMatch) {
              failures.push(`PR body must contain "Closes #<id>".`);
            }

            if (branchMatch && titleMatch && closesMatch) {
              const branchID = branchMatch[1];
              const titleID = titleMatch[1];
              const closesID = closesMatch[1];
              if (!(branchID === titleID && titleID === closesID)) {
                failures.push(
                  `Issue id mismatch: branch=${branchID}, title=${titleID}, closes=${closesID}.`
                );
              }
            }

            if (failures.length > 0) {
              core.setFailed(failures.join("\n"));
            }
